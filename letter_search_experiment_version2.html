<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      font-family: "Times New Roman", Times, serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
      height: 100vh;
    }
    .jspsych-content {
      max-width: 1000px;
      width: 100%;
      margin: auto;
      font-size: 24px;
    }
    .letter-button {
      font-family: monospace;
      display: inline-block;
      width: 17px;
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.1;
      border-radius: 2px;
      cursor: default;
      user-select: none;
    }
    .letter-selected-correct {
      background-color: gold;
      color: black;
    }
    .letter-selected-wrong {
      background-color: lightgray;
      color: black;
    }
    .letter-line {
      margin-bottom: 3.5px;
      white-space: pre;
    }
    .monofont {
      font-family: monospace;
      font-size: 20px;
      white-space: pre;
      display: inline-block;
      max-width: 1000px;
      width: 100%;
      overflow-x: hidden;
    }
    .summary-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="result-container"></div>
</body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData()
  });

  const totalTargets = 320; // âœ… ç›®æ¨™å­—æ¯ç¸½æ•¸
  const clickedCorrectTimes = {}; // âœ… æ¯é æ­£ç¢ºé»æ“Šæ™‚é–“
  const clickedWrongTimes = {}; // âœ… æ¯é éŒ¯èª¤é»æ“Šæ™‚é–“
  const clickedDetails = {}; // âœ… æ¯é æ‰€æœ‰é»æ“Šç´°ç¯€
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''); // âœ… å­—æ¯é™£åˆ—

  // âœ… å›ºå®šæ¯å€‹å­—æ¯çš„å‡ºç¾æ•¸é‡
  const fixedTargetDistribution = [12, 16, 8, 11, 10, 14, 13, 12, 15, 14, 9, 11, 15, 12, 14, 13, 9, 11, 15, 10, 13, 16, 8, 12, 13, 14];
  console.log("ğŸ¯ ç›®æ¨™ç¸½æ•¸ =", fixedTargetDistribution.reduce((a, b) => a + b, 0)); // âœ… å°å‡ºç¸½å’Œæ˜¯å¦ç‚º 320

  // âœ… éš¨æ©Ÿæ‰“äº‚å­—æ¯é †åºï¼ˆå°æ‡‰é é¢é †åºï¼‰
  const shuffledLetters = [...alphabet].sort(() => Math.random() - 0.5);

  const fixedArticles = {}; // âœ… æ¯å€‹å­—æ¯å°æ‡‰çš„å›ºå®šæ–‡ç« å…§å®¹
  const fixedSeeds = {}; // âœ… æ¯å€‹å­—æ¯å°æ‡‰çš„äº‚æ•¸ç¨®å­

  // âœ… å»ºç«‹ç‰¹å®šå­—æ¯çš„å‡æ–‡ç« å…§å®¹ï¼ˆå›ºå®šç¨®å­ï¼‰
  function generateFixedText(letter, count, seed) {
    const allChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ';
    const nonTargetChars = allChars.replace(letter, '');
    const lineLength = 45;
    const totalLines = 25;
    const content = Array(lineLength * totalLines).fill('');
    const rng = mulberry32(seed);
    // âœ… å»ºç«‹ç¬¦åˆæ¢ä»¶çš„ä½ç½®åˆ—è¡¨
    const validPositions = []; // å„²å­˜æ‰€æœ‰å¯æ’å…¥ä½ç½®
    // âœ… å„²å­˜ä¸Šä¸€è¡Œå·²æ’å…¥çš„ä½ç½®ï¼ˆé¿å…ä¸Šä¸‹é‡ç–Šï¼‰
    let lastInsertedCols = new Set();

    for (let line = 0; line < totalLines; line++) {
  let lineInsertedCols = [];

  // âœ… å»ºç«‹å¯èƒ½çš„ column å€¼ï¼ˆ1~43ï¼Œé¿é–‹å…©å´ï¼‰
  let possibleCols = [];
  for (let col = 1; col < lineLength - 1; col++) {
    // âœ… æ’é™¤ä¸Šä¸‹ç›¸é„°çš„ column
    if (!lastInsertedCols.has(col)) {
      possibleCols.push(col);
    }
  }

  // âœ… æ‰“äº‚ column é †åºï¼Œé¿å…åªå¾å·¦é‚ŠæŒ‘
  possibleCols = possibleCols.sort(() => rng() - 0.5);

  for (let col of possibleCols) {
    const pos = line * lineLength + col;
    // âœ… ç¢ºä¿å·¦å³ä¸ç›¸é„°
    if (
      validPositions.includes(pos - 1) ||
      validPositions.includes(pos + 1)
    ) continue;

    validPositions.push(pos);
    lineInsertedCols.push(col);
    if (lineInsertedCols.length >= 2) break; // æ¯è¡Œæœ€å¤š 2 å€‹
  }

  lastInsertedCols = new Set(lineInsertedCols);
}

  // âœ… æ‰“äº‚å¯ç”¨ä½ç½®ä¸¦æŠ½å‡ºéœ€è¦çš„æ•¸é‡
  const shuffled = validPositions.sort(() => rng() - 0.5);
  const positions = shuffled.slice(0, count);
    for (const pos of positions) content[pos] = letter;
    for (let i = 0; i < content.length; i++)
      if (!content[i]) content[i] = nonTargetChars[Math.floor(rng() * nonTargetChars.length)];
    const lines = [];
    for (let i = 0; i < totalLines; i++) {
      const line = content.slice(i * lineLength, (i + 1) * lineLength);
      while (line[0] === ' ') line[0] = nonTargetChars[Math.floor(rng() * nonTargetChars.length)];
      while (line[lineLength - 1] === ' ') line[lineLength - 1] = nonTargetChars[Math.floor(rng() * nonTargetChars.length)];
      lines.push(line.join(''));
    }
    return { lines, answer: count };
  }

  function mulberry32(a) {
    return function () {
      a |= 0; a = a + 0x6D2B79F5 | 0;
      let t = Math.imul(a ^ a >>> 15, 1 | a);
      t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  // âœ… ç‚ºæ¯å€‹å­—æ¯å»ºç«‹æ–‡ç« 
  alphabet.forEach((letter, i) => {
    const seed = i + 1;
    fixedSeeds[letter] = seed;
    fixedArticles[letter] = generateFixedText(letter, fixedTargetDistribution[i], seed);
  });

  // âœ… é é¢è³‡æ–™é…å°ï¼ˆé †åºå·²æ‰“äº‚ï¼‰
  const pages = shuffledLetters.map(letter => {
    return {
      letter,
      text: fixedArticles[letter].lines,
      answer: fixedArticles[letter].answer
    };
  });

  const timeline = [];
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>Letter Search Task</h2><p>You will see 26 fixed texts. Each page has a target letter (A-Z).<br>Click all target letters within 90 seconds.</p>`,
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    clickedCorrectTimes[index] = [];
    clickedWrongTimes[index] = [];
    clickedDetails[index] = [];
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        let html = `<div style="font-size: 22px;"><div class="word-box"><strong>Target Letter: <div style="font-size: 24px;">${page.letter}</strong></div><div class="monofont">`;
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}', '${page.letter}', ${index})">${char}</span>`;
          }
          html += '</div>';
        });
        html += `</div><br><div style="font-size: 16px;"><strong>Page ${index + 1}</strong>`;
        return html;
      },
      choices: ['Continue'],
      trial_duration: 90000,
      on_load: function () {// âœ… å•Ÿå‹•æ™‚é–“è¨˜éŒ„
        window.trialStartTime = performance.now(); // âœ… æ­£ç¢ºåˆå§‹åŒ–æ™‚é–“é»
        pageStartTime = performance.now();
      },
      on_finish: function (data) {
        data.page_total_time = 90; // âœ… æ¯é ç¸½æ™‚é–“å›ºå®š 90 ç§’
        const clicks = clickedCorrectTimes[index] || [];
        const searchTime = clicks.length > 0 ? Math.max(...clicks) : 0;
        data.page_index = index + 1;
        data.letter = page.letter;
        data.correct_answer = page.answer;
        data.user_answer = clicks.length;
        data.accuracy = ((clicks.length / page.answer) * 100).toFixed(1);
        data.time = searchTime.toFixed(2);
        data.clicked_details = clickedDetails[index];
      }
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let html = '<div class="summary-wrapper"><div style="font-size: 20px;"><div><h3 style="text-align:center">Summary</h3><table border="1" cellpadding="5"><tr><th>Page</th><th>Letter</th><th>Correct</th><th>Target</th><th>Accuracy</th><th>Time (s)</th></tr>';
      let totalCorrect = 0, totalTarget = 0, totalTime = 0;
      trials.forEach(t => {
        if (t.page_index) {
          totalCorrect += t.user_answer;
          totalTarget += t.correct_answer;
          totalTime += parseFloat(t.time);
          html += `<tr><td>${t.page_index}</td><td>${t.letter}</td><td>${t.user_answer}</td><td>${t.correct_answer}</td><td>${t.accuracy}%</td><td>${t.time}</td></tr>`;
        }
      });
      const avgAcc = ((totalCorrect / totalTarget) * 100).toFixed(1);
      html += `<tr><th>Total</th><td></td><td>${totalCorrect}</td><td>${totalTarget}</td><td>${avgAcc}%</td><td>${totalTime.toFixed(2)}</td></tr>`;
      html += '</table><br><button onclick="downloadCSV()">Download CSV</button></div></div>';
      return html;
    },
    choices: ['Finish']
  });

  // âœ… é»æ“Šæ¨™è¨˜æ­£ç¢ºèˆ‡å¦
  function toggleLetter(id, char, target, index) {
    const el = document.getElementById(id);
    if (!el || el.classList.contains('letter-selected-correct') || el.classList.contains('letter-selected-wrong')) return;
    const now = (performance.now() - window.trialStartTime) / 1000;
    if (char === target) {
      el.classList.add('letter-selected-correct');
      clickedCorrectTimes[index].push(now);
    } else {
      el.classList.add('letter-selected-wrong');
      clickedWrongTimes[index].push(now);
    }
    clickedDetails[index].push({ char, time: now.toFixed(2), isCorrect: char === target });
  }

  // âœ… åŒ¯å‡º CSVï¼šç¸½çµè¡¨ï¼‹é»æ“Šè©³æƒ…è¡¨
  function downloadCSV() {
    const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
    let summary = 'Page,Letter,Correct,Target,Accuracy,Time,Total Time\n';
    let details = 'Page,Letter,Clicked Letter,Time (s),Correct\n';
    let totalCorrect = 0, totalTarget = 0, totalTime = 0; totalDuration = 0;

    trials.forEach(t => {
      if (t.page_index) {
        totalCorrect += t.user_answer;
        totalTarget += t.correct_answer;
        totalTime += parseFloat(t.time);
        totalDuration += t.page_total_time || 0;
        summary += `${t.page_index},${t.letter},${t.user_answer},${t.correct_answer},${t.accuracy}%,${t.time},${t.page_total_time} seconds\n`;
        t.clicked_details.forEach(d => {
          details += `${t.page_index},${t.letter},${d.char},${d.time},${d.isCorrect ? 'Yes' : 'No'}\n`;
        });
      }
    });
    const acc = ((totalCorrect / totalTarget) * 100).toFixed(1);
    summary += `Total,,${totalCorrect},${totalTarget},${acc}%,${totalTime.toFixed(2)},${totalDuration}\n`;

    const blob = new Blob([summary + '\n' + details], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'letter_search_result.csv';
    a.click();
  }

  jsPsych.run(timeline);
</script>
</html>
