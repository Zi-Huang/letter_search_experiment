<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letter Search Game - Fixed Articles</title>
  <link href="jspsych.css" rel="stylesheet" />
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #fff;
      font-family: "Times New Roman", serif;
    }
    .article {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 1vh;
      box-sizing: border-box;
    }
    .line {
      font-size: 1.6vh;
      line-height: 1.2;
      white-space: pre;
      font-family: "Times New Roman", serif;
    }
    .letter {
      display: inline-block;
      padding: 0.2vh;
      margin: 0;
      cursor: pointer;
      user-select: none;
    }
    .selected {
      background-color: gold;
      color: black;
    }
    .target-display {
      font-size: 2vh;
      font-weight: bold;
      margin-bottom: 1vh;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
    const articles = {
      "A": { "target": "A", "targetCount": 11, "content": [
        "8PTLV61FE24RHD3D7CGD2ZG0RYOYTHNBSST245GVVVR05",
        "P19E2959GBV7ZZ06CY8W217944C4BO8RV45GD9JRTNKSX",
        "X8ZUU16XKYC6YE3RK7UP6VK1Y9DX0OQ08V3CCD94UT9JX",
        // ... 22 more lines
      ] },
      // 其餘 B ~ Z 的資料，略，請貼入完整 articles 物件
    };

    const timeline = [];
    const results = [];

    const letters = Object.keys(articles);

    letters.forEach(letter => {
      const article = articles[letter];
      const contentLines = article.content;

      timeline.push({
        type: 'html-button-response',
        stimulus: () => {
          const target = article.target;
          let html = `<div class='article'><div class='target-display'>目標字母：<span>${target}</span></div>`;
          contentLines.forEach((line, lineIndex) => {
            html += `<div class='line'>`;
            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              html += `<span class='letter' data-line='${lineIndex}' data-index='${i}' onclick='toggleSelection(this)'>${char}</span>`;
            }
            html += `</div>`;
          });
          html += `</div>`;
          return html;
        },
        choices: [],
        trial_duration: 90000,
        on_finish: (data) => {
          const correct = document.querySelectorAll('.letter.selected');
          let correctCount = 0;
          correct.forEach(el => {
            if (el.textContent === articles[letter].target) correctCount++;
          });
          results.push({
            letter,
            time: data.rt / 1000,
            correct: correctCount,
            targetTotal: articles[letter].targetCount,
            accuracy: ((correctCount / articles[letter].targetCount) * 100).toFixed(1) + "%"
          });
        }
      });
    });

    timeline.push({
      type: 'html-button-response',
      stimulus: () => {
        let html = '<h2>完成！結果如下：</h2><table border="1" cellpadding="5" style="font-size:1.5vh;"><tr><th>字母</th><th>正確數</th><th>應找數</th><th>時間（秒）</th><th>準確率</th></tr>';
        results.forEach(r => {
          html += `<tr><td>${r.letter}</td><td>${r.correct}</td><td>${r.targetTotal}</td><td>${r.time.toFixed(1)}</td><td>${r.accuracy}</td></tr>`;
        });
        html += '</table><br><button onclick="downloadCSV()">下載 CSV</button>';
        return html;
      },
      choices: ['結束']
    });

    function toggleSelection(el) {
      el.classList.toggle('selected');
    }

    function downloadCSV() {
      let csv = 'Letter,Correct,Target Total,Time,Accuracy\n';
      results.forEach(r => {
        csv += `${r.letter},${r.correct},${r.targetTotal},${r.time.toFixed(1)},${r.accuracy}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'letter_search_results.csv';
      a.click();
    }

    jsPsych.init({ timeline });
  </script>
</body>
</html>
