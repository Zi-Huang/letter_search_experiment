<!DOCTYPE html> <!-- 宣告 HTML5 文件類型 -->
<html lang="en"> <!-- 設定語言為英文 -->
<head>
  <meta charset="UTF-8" /> <!-- 設定字元編碼 -->
  <title>Letter Search Experiment</title> <!-- ✅ 保留中文標題 -->
  <script src="jspsych.js"></script> <!-- 載入 jsPsych 核心腳本 -->
  <script src="plugin-html-button-response.js"></script> <!-- 載入 html-button-response 插件 -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- 載入 jsPsych 樣式表 -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* ✅ 防止畫面橫向捲動 */
      box-sizing: border-box; /* 保證 padding 不會超出寬度限制 */
    }
    body {
      font-family: "Times New Roman", Times, serif; /* 設定字體為 Times New Roman */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
      height: 100vh;
    }
    .jspsych-content {
      max-width: 1000px;
      width: 100%;
      margin: auto;
      font-size: 20px;
    }
    .letter-button {
      font-family: monospace; /* ✅ 等寬字體確保對齊 */
      display: inline-block;
      width: 17px; /* ✅ 固定寬度確保整齊排版 */
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.1;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
    }
    .letter-selected-correct {
      background-color: gold; /* ✅ 標記選取 A 字母 */
      color: black;
    }
    .letter-line {
      margin-bottom: 3.5px; /* ✅ 每行底部間距調整 */
      white-space: pre;
    }
    .monofont {
      font-family: monospace;
      font-size: 20px;
      white-space: pre;
      display: inline-block;
      max-width: 1000px;
      width: 100%;
      overflow-x: hidden;
    }
  </style>
</head>
<body>
  <div id="result-container"></div> <!-- ✅ 顯示實驗結束結果表格的區塊 -->
</body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData() // ✅ 實驗結束時顯示資料
  });

  const clickedASet = new Set(); // ✅ 記錄使用者點擊的 A ID 集合

  const pages = []; // ✅ 存放所有 26 篇文章內容
  const pageTargets = []; // ✅ 每篇文章目標字母數量紀錄
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  // ✅ 每篇文章一個固定目標字母（A-Z）與 8~15 個該字母
  for (let i = 0; i < 26; i++) {
    const target = alphabet[i]; // ✅ 設定該篇目標字母
    const count = Math.floor(Math.random() * 8) + 8; // ✅ 目標字母數量：8~15
    const result = generateFixedPageText(target, count);
    pages.push({ text: result.lines, answer: result.answer, letter: target });
  }

  // ✅ 固定內容：產生 25 行 × 45 字（含指定數量目標字母）
  function generateFixedPageText(targetLetter = 'A', totalTargets = 12) {
    const allChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const nonTargetChars = allChars.replace(targetLetter, '');
    const lineLength = 45;
    const lines = Array(25).fill('');
    const A_locations = {};

    while (totalTargets > 0) {
      const lineIdx = Math.floor(Math.random() * 25);
      if (!A_locations[lineIdx]) A_locations[lineIdx] = [];
      if (A_locations[lineIdx].length < 2) {
        let pos;
        do {
          pos = Math.floor(Math.random() * lineLength);
        } while (A_locations[lineIdx].includes(pos));
        A_locations[lineIdx].push(pos);
        totalTargets--;
      }
    }

    for (let i = 0; i < 25; i++) {
      const chars = [];
      for (let j = 0; j < lineLength; j++) {
        if (A_locations[i] && A_locations[i].includes(j)) {
          chars.push(targetLetter); // ✅ 插入目標字母
        } else {
          chars.push(nonTargetChars[Math.floor(Math.random() * nonTargetChars.length)]); // ✅ 插入隨機非目標字
        }
      }
      lines[i] = chars.join(''); // ✅ 組成一行
    }
    const count = Object.values(A_locations).reduce((a, b) => a + b.length, 0); // ✅ 總目標字數
    return { lines, answer: count };
  }

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Letter Search Task</h2>
      <p>You will see 26 fake text, each with a designated target letter (such as A~Z). <br>
        Please click on all the target letters you find, within 90 seconds</p>`,
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        clickedASet.clear();
        let html = `<div class="word-box">Target Letter：${page.letter}</div><div class="monofont">`;
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}', '${page.letter}')">${char}</span>`;
          }
          html += '</div>'; // ✅ 每行結束
        });
        html += `</div><br><strong>Page ${index + 1}`;
        return html;
      },
      choices: ['Continue'],
      trial_duration: 90000, // ✅ 每頁 90 秒
      on_finish: function (data) {
        const correctCount = clickedASet.size;
        data.user_answer = correctCount;
        data.correct_answer = page.answer;
        data.page_index = index + 1;
        data.letter = page.letter;
        data.accuracy = ((Math.min(correctCount, page.answer) / page.answer) * 100).toFixed(1);
      }
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let html = '<h3>Result</h3><table border="1" cellpadding="5"><tr><th>Target</th><th>Correct</th><th>Answer</th><th>Accuracy</th></tr>';
      trials.forEach(t => {
        if (t.page_index) {
          html += `<tr><td>${t.letter}</td><td>${t.user_answer}</td><td>${t.correct_answer}</td><td>${t.accuracy}%</td></tr>`;
        }
      });
      html += '</table><br><button onclick="downloadCSV()">Download CSV</button>';
      return html;
    },
    choices: ['Finish']
  });

  function toggleLetter(id, char, target) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct')) {
      el.classList.remove('letter-selected-correct');
      clickedASet.delete(id);
    } else {
      if (char === target) {
        el.classList.add('letter-selected-correct');
        clickedASet.add(id);
      }
    }
  }

  function downloadCSV() {
    const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
    let csv = 'Letter,Correct,Target,Accuracy\n';
    trials.forEach(t => {
      if (t.page_index) {
        csv += `${t.letter},${t.user_answer},${t.correct_answer},${t.accuracy}%\n`;
      }
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'letter_search_result.csv';
    a.click();
  }

  jsPsych.run(timeline);
</script>
</html>
