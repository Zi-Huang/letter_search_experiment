<!DOCTYPE html> <!-- 宣告 HTML5 文件類型 -->
<html lang="en"> <!-- 設定語言為英文 -->
<head>
  <meta charset="UTF-8" /> <!-- 設定字元編碼 -->
  <title>Letter Search Experiment</title> <!-- ✅ 保留中文標題 -->
  <script src="jspsych.js"></script> <!-- 載入 jsPsych 核心腳本 -->
  <script src="plugin-html-button-response.js"></script> <!-- 載入 html-button-response 插件 -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- 載入 jsPsych 樣式表 -->
  <style>
    html, body {
      margin: 0; /* ✅ 移除預設邊距 */
      padding: 0; /* ✅ 移除預設內距 */
      overflow-x: hidden; /* ✅ 防止橫向捲動 */
      box-sizing: border-box; /* ✅ 包含 padding 計算寬高 */
    }
    body {
      font-family: "Times New Roman", Times, serif; /* ✅ 設定字型 */
      display: flex; /* ✅ 使用 flex 排版 */
      flex-direction: column; /* ✅ 垂直排列 */
      align-items: center; /* ✅ 置中對齊 */
      padding: 2vh 1vw; /* ✅ 四周留白 */
      height: 100vh; /* ✅ 滿版高度 */
    }
    .jspsych-content {
      max-width: 1000px; /* ✅ 限制最大寬度 */
      width: 100%; /* ✅ 寬度自動撐滿 */
      margin: auto; /* ✅ 置中 */
      font-size: 20px; /* ✅ 字體大小 */
    }
    .letter-button {
      font-family: monospace; /* ✅ 使用等寬字體 */
      display: inline-block; /* ✅ 行內區塊顯示 */
      width: 17px; /* ✅ 固定寬度 */
      text-align: center; /* ✅ 置中文字 */
      padding: 0px; /* ✅ 無內距 */
      margin: 0px; /* ✅ 無外距 */
      line-height: 1.1; /* ✅ 行高 */
      border-radius: 2px; /* ✅ 邊角圓弧 */
      cursor: pointer; /* ✅ 滑鼠指標 */
      user-select: none; /* ✅ 禁止選取 */
    }
    .letter-selected-correct {
      background-color: gold; /* ✅ 標示點選 */
      color: black; /* ✅ 點選顏色 */
    }
    .letter-line {
      margin-bottom: 3.5px; /* ✅ 每行間距 */
      white-space: pre; /* ✅ 保留空白格式 */
    }
    .monofont {
      font-family: monospace; /* ✅ 等寬字體 */
      font-size: 20px; /* ✅ 字體大小 */
      white-space: pre; /* ✅ 保持行排版 */
      display: inline-block; /* ✅ 區塊顯示 */
      max-width: 1000px; /* ✅ 最大寬度限制 */
      width: 100%; /* ✅ 撐滿容器 */
      overflow-x: hidden; /* ✅ 不顯示橫向捲軸 */
    }
    .summary-wrapper {
      display: flex; /* ✅ 使用 flex 容器 */
      justify-content: center; /* ✅ 水平置中 */
      margin-top: 20px; /* ✅ 上方留白 */
    }
  </style>
</head>
<body>
  <div id="result-container"></div> <!-- ✅ 顯示結果區塊 -->
</body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData() /* ✅ 實驗結束顯示資料 */
  });

  const clickedASet = new Set(); /* ✅ 記錄使用者點選 */

  const totalTargets = 320; /* ✅ 總目標字數改為 320 */ /* ✅ 總目標字數 */
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').sort(() => Math.random() - 0.5); /* ✅ 打亂順序 */
  function generateDistribution(targetTotal = 320, pageCount = 26, min = 8, max = 16) {
  let dist = Array(pageCount).fill(min);
  let remaining = targetTotal - min * pageCount;
  while (remaining > 0) {
    const idx = Math.floor(Math.random() * pageCount);
    if (dist[idx] < max) {
      dist[idx]++;
      remaining--;
    }
  }
  return dist;
}
const distribution = generateDistribution(320, 26, 8, 16);

  const pages = alphabet.map((letter, idx) => {
    const result = generateFixedPageText(letter, distribution[idx]);
    return { text: result.lines, answer: result.answer, letter: letter };
  });

  function generateFixedPageText(targetLetter = 'A', totalTargets = 12) {
    const allChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ';
    const nonTargetChars = allChars.replace(targetLetter, '');
    const lineLength = 45;
    const totalLines = 25;
    const content = Array(lineLength * totalLines).fill('');

    const positions = [...Array(lineLength * totalLines).keys()];
    const targetPos = positions.sort(() => Math.random() - 0.5).slice(0, totalTargets);
    for (const pos of targetPos) content[pos] = targetLetter;
    for (let i = 0; i < content.length; i++) if (!content[i]) content[i] = randomChar(nonTargetChars);

    const lines = [];
    for (let i = 0; i < totalLines; i++) {
      const line = content.slice(i * lineLength, (i + 1) * lineLength);
      if (line[0] === ' ') line[0] = randomChar(nonTargetChars);
      if (line[44] === ' ') line[44] = randomChar(nonTargetChars);
      lines.push(line.join(''));
    }
    return { lines, answer: totalTargets };
  }

  function randomChar(set) {
    return set[Math.floor(Math.random() * set.length)];
  }

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>Letter Search Task</h2><p>You will see 26 fixed texts. Each page has a target letter (A-Z).<br>Click all target letters within 90 seconds.</p>`,
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        clickedASet.clear();
        let html = `<div style="font-size: 22px;"><div class="word-box"><strong>Target Letter: ${page.letter}</strong></div><div class="monofont">`;
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}', '${page.letter}')">${char}</span>`;
          }
          html += '</div>'; /* ✅ 每行結束 */
        });
        html += `</div><br><strong>Page ${index + 1}</strong>`;
        return html;
      },
      choices: ['Next'],
      trial_duration: 90000,
      on_start: function (trial) {
        trial.data = { startTime: performance.now() };
      },
      on_finish: function (data) {
        const correctCount = clickedASet.size;
        const endTime = performance.now();
        const elapsed = ((endTime - (data.startTime || performance.now())) / 1000).toFixed(2); /* ✅ 修正 NaN 錯誤 */
        data.user_answer = correctCount;
        data.correct_answer = page.answer;
        data.page_index = index + 1;
        data.letter = page.letter;
        data.accuracy = ((Math.min(correctCount, page.answer) / page.answer) * 100).toFixed(1);
        data.time = elapsed;
      }
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let html = '<div class="summary-wrapper"><div><h3 style="text-align:center">Summary</h3><table border="1" cellpadding="5"><tr><th>Page</th><th>Letter</th><th>Correct</th><th>Target</th><th>Accuracy</th><th>Time (s)</th></tr>';
      let totalCorrect = 0, totalTarget = 0, totalTime = 0;
      trials.forEach(t => {
        if (t.page_index) {
          totalCorrect += t.user_answer;
          totalTarget += t.correct_answer;
          totalTime += parseFloat(t.time);
          html += `<tr><td>${t.page_index}</td><td>${t.letter}</td><td>${t.user_answer}</td><td>${t.correct_answer}</td><td>${t.accuracy}%</td><td>${t.time}</td></tr>`;
        }
      });
      const totalAccuracy = ((totalCorrect / totalTarget) * 100).toFixed(1);
      html += `<tr><th>Total</th><td></td><td>${totalCorrect}</td><td>${totalTarget}</td><td>${totalAccuracy}%</td><td>${totalTime.toFixed(2)}</td></tr>`;
      html += '</table><br><button onclick="downloadCSV()">Download CSV</button></div></div>';
      return html;
    },
    choices: ['Finish']
  });

  function toggleLetter(id, char, target) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct')) {
      el.classList.remove('letter-selected-correct');
      clickedASet.delete(id);
    } else {
      if (char === target) {
        el.classList.add('letter-selected-correct');
        clickedASet.add(id);
      }
    }
  }

  function downloadCSV() {
    const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
    let csv = 'Page,Letter,Correct,Target,Accuracy,Time\n';
    let totalCorrect = 0, totalTarget = 0, totalTime = 0;
    trials.forEach(t => {
      if (t.page_index) {
        totalCorrect += t.user_answer;
        totalTarget += t.correct_answer;
        totalTime += parseFloat(t.time);
        csv += `${t.page_index},${t.letter},${t.user_answer},${t.correct_answer},${t.accuracy}%,${t.time}\n`;
      }
    });
    const totalAccuracy = ((totalCorrect / totalTarget) * 100).toFixed(1);
    csv += `Total,,${totalCorrect},${totalTarget},${totalAccuracy}%,${totalTime.toFixed(2)}\n`;
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'letter_search_result.csv';
    a.click();
  }

  jsPsych.run(timeline); /* ✅ 啟動實驗流程 */
</script>
</html>
