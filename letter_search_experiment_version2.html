<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- ✅ 加入 SheetJS 生成 Excel -->
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      font-family: "Times New Roman", Times, serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
      height: 100vh;
    }
    .jspsych-content {
      max-width: 1000px;
      width: 100%;
      margin: auto;
      font-size: 20px;
    }
    .letter-button {
      font-family: monospace;
      display: inline-block;
      width: 17px;
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.1;
      border-radius: 2px;
      cursor: default;
      user-select: none;
    }
    .letter-selected-correct {
      background-color: gold;
      color: black;
    }
    .letter-selected-wrong {
      background-color: lightgray;
      color: black;
    }
    .letter-line {
      margin-bottom: 3.5px;
      white-space: pre;
    }
    .monofont {
      font-family: monospace;
      font-size: 20px;
      white-space: pre;
      display: inline-block;
      max-width: 1000px;
      width: 100%;
      overflow-x: hidden;
    }
    .summary-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="result-container"></div> <!-- ✅ 顯示結果區塊 -->
</body>
<script>
// ✅ 補充下載 Excel 檔案的版本
function downloadCSV() {
  const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
  const summaryRows = [
    ['Page', 'Letter', 'Correct', 'Target', 'Accuracy (%)', 'Time (s)']
  ];
  const clickRows = [
    ['Page', 'Letter', 'Type', 'Time (s)']
  ];

  let totalCorrect = 0, totalTarget = 0, totalTime = 0;

  trials.forEach(t => {
    if (t.page_index) {
      totalCorrect += t.user_answer;
      totalTarget += t.correct_answer;
      totalTime += parseFloat(t.time);
      summaryRows.push([t.page_index, t.letter, t.user_answer, t.correct_answer, t.accuracy, t.time]);
      (t.correct_timestamps || []).forEach(sec => clickRows.push([t.page_index, t.letter, 'correct', sec]));
      (t.wrong_timestamps || []).forEach(sec => clickRows.push([t.page_index, t.letter, 'wrong', sec]));
    }
  });

  const acc = ((totalCorrect / totalTarget) * 100).toFixed(1);
  summaryRows.push(['Total', '', totalCorrect, totalTarget, acc, totalTime.toFixed(2)]);

  const wb = XLSX.utils.book_new();
  const summarySheet = XLSX.utils.aoa_to_sheet(summaryRows);
  const clickSheet = XLSX.utils.aoa_to_sheet(clickRows);

  XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
  XLSX.utils.book_append_sheet(wb, clickSheet, 'ClickTimes');

  XLSX.writeFile(wb, 'letter_search_result.xlsx');
}
</script>
</html>
