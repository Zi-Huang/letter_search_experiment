<!DOCTYPE html> <!-- ÂÆ£Âëä HTML5 Êñá‰ª∂È°ûÂûã -->
<html lang="en"> <!-- Ë®≠ÂÆöË™ûË®ÄÁÇ∫Ëã±Êñá -->
<head>
  <meta charset="UTF-8" /> <!-- Ë®≠ÂÆöÂ≠óÂÖÉÁ∑®Á¢º -->
  <title>Letter Search Experiment</title> <!-- Á∂≤È†ÅÊ®ôÈ°å -->
  <script src="jspsych.js"></script> <!-- ËºâÂÖ• jsPsych Ê†∏ÂøÉËÖ≥Êú¨ -->
  <script src="plugin-html-button-response.js"></script> <!-- ËºâÂÖ• html-button-response Êèí‰ª∂ -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- ËºâÂÖ• jsPsych Ê®£ÂºèË°® -->
  <style>
    html, body {
      margin: 0;
      padding: 0px;
      overflow-x: hidden; /* ‚úÖ Èò≤Ê≠¢Áï´Èù¢Ê©´ÂêëÊç≤Âãï */
      box-sizing: border-box;
    }
    body {
      font-family: "Times New Roman", Times, serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
      height: 100vh;
    }
    .jspsych-content {
      max-width: 1000px;
      width: 100%;
      margin: auto;
      font-size: 20px;
    }
    .letter-button {
      font-family: monospace;
      display: inline-block;
      width: 17px;
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.1;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
    }
    .letter-selected-correct {
      background-color: gold;
      color: black;
    }
    .letter-line {
      margin-bottom: 3.5px; /* ‚úÖ ÊØèË°åÂ∫ïÈÉ®ÈñìË∑ù */
      white-space: pre;
    }
    .monofont {
      font-family: monospace;
      font-size: 20px;
      white-space: pre;
      display: inline-block;
      max-width: 1000px;
      width: 100%;
      overflow-x: hidden;
    }
  </style>
</head>
<body>
  <div id="result-container" style="text-align: center;"></div> <!-- ‚úÖ È°ØÁ§∫ÁµêÊûúÂçÄÂ°äÔºåÁΩÆ‰∏≠È°ØÁ§∫ -->
</body>
<script>
const jsPsych = initJsPsych({
  on_finish: () => jsPsych.data.displayData()
});
const clickedASet = new Set();

const totalTargets = 320;
const minTargetsPerPage = 8;
const maxTargetsPerPage = 16;
const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const pages = [];

function distributeTargets(total, pages, min, max) {
  const arr = Array(pages).fill(min);
  let remaining = total - min * pages;
  while (remaining > 0) {
    const i = Math.floor(Math.random() * pages);
    if (arr[i] < max) {
      arr[i]++;
      remaining--;
    }
  }
  return arr;
}

function generateFixedPage(letter, count) {
  const lineCount = 25;
  const lineLength = 45;
  const nonTarget = letters.replace(letter, '');
  const lines = [];
  const targetPositions = {};
  while (count > 0) {
    const row = Math.floor(Math.random() * lineCount);
    const col = Math.floor(Math.random() * lineLength);
    if (!targetPositions[row]) targetPositions[row] = new Set();
    if (targetPositions[row].size < 2 && !targetPositions[row].has(col)) {
      targetPositions[row].add(col);
      count--;
    }
  }
  for (let i = 0; i < lineCount; i++) {
    const chars = [];
    for (let j = 0; j < lineLength; j++) {
      if (targetPositions[i] && targetPositions[i].has(j)) {
        chars.push(letter);
      } else {
        if (j > 0 && j < lineLength - 1 && Math.random() < 0.15) {
          chars.push(' ');
        } else {
          chars.push(nonTarget[Math.floor(Math.random() * nonTarget.length)]);
        }
      }
    }
    if (chars[0] === ' ') chars[0] = nonTarget[Math.floor(Math.random() * nonTarget.length)];
    if (chars[lineLength - 1] === ' ') chars[lineLength - 1] = nonTarget[Math.floor(Math.random() * nonTarget.length)];
    lines.push(chars.join(''));
  }
  return { lines: lines, answer: Array.from(Object.values(targetPositions)).reduce((a, b) => a + b.size, 0) };
}

const targetsPerPage = distributeTargets(totalTargets, 26, minTargetsPerPage, maxTargetsPerPage);
const letterSequence = letters.split('').sort(() => Math.random() - 0.5);
letterSequence.forEach((letter, i) => {
  const page = generateFixedPage(letter, targetsPerPage[i]);
  pages.push({
    text: page.lines,
    answer: page.answer,
    target: letter
  });
});

const timeline = [];

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>Letter Search Task</h2>
    <p>You will see 26 pages of text. Each page asks you to find a target letter (e.g., A, B...).<br>
    Click all instances of the target letter. You have 90 seconds per page.<br>Click "Start" to begin.</p>`,
  choices: ['Start']
});

pages.forEach((pageData, index) => {
  const page = pageData; // ‚úÖ ‰ΩøÁî®ÈñâÂåÖÁ¢∫‰øùÊ≠£Á¢∫ÂºïÁî®
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    on_start: function(trial){ trial.data.startTime = performance.now(); },
    stimulus: function () {
      clickedASet.clear();
      let html = `<div><h3>Find all letters: ${page.target}</h3><div class="monofont">`;
      page.text.forEach((line, i) => {
        html += '<div class="letter-line">';
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          const id = `char_${index}_${i}_${j}`;
          html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}', '${page.target}')">${char}</span>`;
        }
        html += '</div>'; /* ‚úÖ ÊØèË°åÂ∫ïÈÉ®ÈñìË∑ùË™øÊï¥ */
      });
      html += `</div><br><strong>Page ${index + 1} of 26</strong>`;
      return html;
    },
    choices: ['Continue'],
    trial_duration: 90000,
    on_finish: function (data) {
      const end = performance.now();
      let correctCount = clickedASet.size;
      data.user_answer = correctCount;
      data.correct_answer = page.answer;
      data.correct = (correctCount === page.answer);
      data.correct_diff = Math.min(correctCount, page.answer);
      data.page_index = index + 1;
      data.page_time_sec = Math.round((end - data.startTime) / 1000);
      data.page_accuracy = ((data.correct_diff / data.correct_answer) * 100).toFixed(1);
      data.target_letter = page.target;
    }
  });
});

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: function () {
    const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
    let html = '<div style="text-align:center"><h2>Results</h2><table border="1" style="margin:auto"><tr><th>Page</th><th>Target</th><th>Answer</th><th>Correct</th><th>Time (s)</th><th>Accuracy (%)</th></tr>';
    let totalCorrect = 0, totalAnswer = 0, totalTime = 0;
    const summary = [];
    trials.forEach(t => {
      if (t.page_index) {
        const matched = Math.min(t.user_answer, t.correct_answer);
        const acc = ((matched / t.correct_answer) * 100).toFixed(1);
        totalCorrect += matched;
        totalAnswer += t.correct_answer;
        totalTime += t.page_time_sec;
        html += `<tr><td>${t.page_index}</td><td>${t.target_letter}</td><td>${t.correct_answer}</td><td>${matched}</td><td>${t.page_time_sec}</td><td>${acc}</td></tr>`;
        summary.push({Page: t.page_index, Target: t.target_letter, Answer: t.correct_answer, Correct: matched, "Time (sec)": t.page_time_sec, "Accuracy (%)": acc});
      }
    });
    const overallAcc = ((totalCorrect / totalAnswer) * 100).toFixed(1);
    html += `</table><p><strong>Total: ${totalCorrect}/${totalAnswer}</strong><br>Total Time: ${totalTime}s<br>Overall Accuracy: ${overallAcc}%</p>`;
    html += `<br><button onclick="downloadCSV()">üì• Download CSV</button></div>`;
    window.summaryData = summary;
    window.summaryTotals = { totalCorrect, totalAnswer, totalTime, overallAcc };
    return html;
  },
  choices: ['Finish']
});

function toggleLetter(id, char, target) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.classList.contains('letter-selected-correct')) {
    el.classList.remove('letter-selected-correct');
    clickedASet.delete(id);
  } else {
    if (char === target) {
      el.classList.add('letter-selected-correct');
      clickedASet.add(id);
    }
  }
}

function downloadCSV() {
  const rows = window.summaryData;
  const totals = window.summaryTotals;
  if (!rows || !rows.length) return;
  const header = Object.keys(rows[0]);
  let csv = [header.join(",")].concat(rows.map(r => header.map(h => r[h]).join(","))).join("\n");
  if (totals) {
    csv += `\nTotal, ,${totals.totalAnswer},${totals.totalCorrect},${totals.totalTime},${totals.overallAcc}%`;
  }
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `letter_search_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

jsPsych.run(timeline);
</script>
</html>
