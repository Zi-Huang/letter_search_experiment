<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: Times New Roman, serif;
      padding: 40px;
    }
    .jspsych-content {
      max-width: 1400px;
      margin: auto;
      font-size: 20px;
    }
    .letter-button {
      display: inline-block;
      padding: 2px 3px;
      margin: 0px;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
      font-size: 20px;
      line-height: 1.2;
    }
    .letter-selected-correct {
      background-color: gold;
      color: black;
    }
    .letter-selected-wrong {
      background-color: lightgray;
      color: black;
    }
    .letter-line {
      margin-bottom: 6px;
      white-space: pre;
    }
  </style>
</head>
<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData()
  });

  function generateFakeLine(targetLetter, targetCount, lineLength = 45) {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
    let line = '';
    while (line.length < lineLength - 5) {
      let wordLength = Math.floor(Math.random() * 5) + 1; // words 1â€“5 letters
      let word = '';
      for (let i = 0; i < wordLength; i++) {
        word += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      if (line.length + word.length + 1 <= lineLength) {
        line += word + ' ';
      } else {
        break;
      }
    }
    line = line.trim();
    while (line.length < lineLength) {
      line += alphabet[Math.floor(Math.random() * alphabet.length)];
    }

    let flat = line.split('');
    let positions = [];
    while (positions.length < targetCount) {
      let idx = Math.floor(Math.random() * flat.length);
      if (flat[idx] !== targetLetter && flat[idx] !== ' ') {
        flat[idx] = targetLetter;
        positions.push(idx);
      }
    }
    return flat.join('').slice(0, lineLength); // ensure fixed length, no trailing space
  }

  const pages = [];
  const answers = [];
  for (let p = 0; p < 20; p++) {
    let pageText = [];
    let totalTargets = 0;
    for (let i = 0; i < 25; i++) {
      let lineTargets = Math.floor(Math.random() * 2) + 1;
      let line = generateFakeLine('A', lineTargets, 45);
      pageText.push(line);
      totalTargets += lineTargets;
    }
    let finalTotal = Math.max(8, Math.min(15, totalTargets));
    answers.push(finalTotal);
    pages.push({ text: pageText, answer: finalTotal });
  }

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Letter Search Task</h2><p>Please read the text below and find the letter "A". Total: 20 pages. Click the letters you found, then enter your count.</p>',
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        let html = '<div class="monofont">';
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" onclick="toggleLetter('${id}', '${char}')">${char}</span>`;
          }
          html += '</div>';
        });
        html += `</div><br><label for="count_input_${index}">How many A's did you find?</label>`;
        html += `<input type="number" id="count_input_${index}" /><br><br>`;
        html += `<button onclick="submitCount(${index}, ${page.answer})">Submit</button>`;
        return html;
      },
      choices: []
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let resultHTML = '<h2>Results</h2><ol>';
      let totalCorrect = 0;
      let totalAnswer = 0;

      trials.forEach(t => {
        if (t.user_answer !== undefined) {
          const correct = t.correct_answer;
          const matched = Math.min(t.user_answer, correct);
          totalCorrect += matched;
          totalAnswer += correct;
          resultHTML += `<li>Page ${t.page_index}: Your Answer = <strong>${t.user_answer}</strong> / Actual = <strong>${correct}</strong></li>`;
        }
      });

      resultHTML += `</ol><p><strong>Total A's Correct: ${totalCorrect}/${totalAnswer}</strong></p>`;
      return resultHTML;
    },
    choices: ['Finish']
  });

  function toggleLetter(id, char) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct') || el.classList.contains('letter-selected-wrong')) {
      el.classList.remove('letter-selected-correct');
      el.classList.remove('letter-selected-wrong');
    } else {
      if (char === 'A') {
        el.classList.add('letter-selected-correct');
      } else {
        el.classList.add('letter-selected-wrong');
      }
    }
  }

  function submitCount(index, correct_answer) {
    const val = parseInt(document.getElementById(`count_input_${index}`).value);
    jsPsych.finishTrial({
      user_answer: val,
      correct_answer: correct_answer,
      page_index: index + 1
    });
  }

  jsPsych.run(timeline);
</script>
</html>
