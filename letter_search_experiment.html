<!DOCTYPE html> <!-- 宣告 HTML5 文件類型 -->
<html lang="en"> <!-- 設定語言為英文 -->
<head>
  <meta charset="UTF-8" /> <!-- 設定字元編碼 -->
  <title>Letter Search Experiment</title> <!-- 網頁標題 -->
  <script src="jspsych.js"></script> <!-- 載入 jsPsych 核心腳本 -->
  <script src="plugin-html-button-response.js"></script> <!-- 載入 html-button-response 插件 -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- 載入 jsPsych 樣式表 -->
  <style>
    body {
      font-family: "Times New Roman", Times, serif; /* 設定字體為 Times New Roman */
      padding: 40px; /* 頁面留白 */
    }
    .jspsych-content {
      max-width: 1400px; /* 中央內容最大寬度 */
      margin: auto; /* 置中 */
      font-size: 20px; /* 文字大小 */
    }
    .letter-button {
      font-family: Times New Roman; /* 等寬字體確保對齊 */
      display: inline-block;
      width: 20px; /* 固定寬度以確保字元整齊 */
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.2;
      border-radius: 2px; /* 小圓角 */
      cursor: pointer;
      user-select: none; /* 禁止文字選取 */
    }
    .letter-selected-correct {
      background-color: gold; /* 點選 A 顯示黃色背景 */
      color: black;
    }
    .letter-line {
      margin-bottom: 6px; /* 每行底部間距 */
      white-space: pre; /* 保留空格與排版 */
    }
    .monofont {
      font-family: Times New Roman; /* 等寬字型確保字元對齊 */
      font-size: 20px; /* 字體大小 */
      white-space: pre; /* 保留空格 */
    }
  </style>
</head>
<body></body> <!-- 空的 body，由 jsPsych 動態填入內容 -->
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData() // 結束後顯示資料
  });

  const clickedASet = new Set(); // 儲存使用者點擊 A 的 ID

  // 生成一頁假文章，包含 0~2 個 A/行，總數在 8~15
  function generatePageText(targetLetter = 'A') {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lines = Array(25).fill(''); // 一頁 25 行
    const lineLength = 45; // 每行 45 字
    let totalTargets = Math.floor(Math.random() * 8) + 8; // 隨機產生 8~15 個 A
    const A_locations = {}; // 紀錄 A 所在位置

    // 隨機分配 A 到不同行與位置
    while (totalTargets > 0) {
      const lineIdx = Math.floor(Math.random() * 25);
      if (!A_locations[lineIdx]) A_locations[lineIdx] = [];
      if (A_locations[lineIdx].length < 2) {
        let pos;
        do {
          pos = Math.floor(Math.random() * lineLength);
        } while (A_locations[lineIdx].includes(pos));
        A_locations[lineIdx].push(pos);
        totalTargets--;
      }
    }

    // 產生每行文字內容
    for (let i = 0; i < 25; i++) {
      const charArray = [];
      for (let j = 0; j < lineLength; j++) {
        if (A_locations[i] && A_locations[i].includes(j)) {
          charArray.push(targetLetter); // 插入 A
        } else {
          if (j > 0 && j < lineLength - 1 && Math.random() < 0.15) {
            charArray.push(' '); // 隨機加入空格
          } else {
            charArray.push(alphabet[Math.floor(Math.random() * alphabet.length)]); // 插入隨機字母
          }
        }
      }
      // 修正首尾不為空格
      if (charArray[0] === ' ') charArray[0] = alphabet[Math.floor(Math.random() * alphabet.length)];
      if (charArray[lineLength - 1] === ' ') charArray[lineLength - 1] = alphabet[Math.floor(Math.random() * alphabet.length)];
      lines[i] = charArray.join('');
    }

    // 回傳該頁文字與 A 的數量
    const count = Object.values(A_locations).reduce((acc, arr) => acc + arr.length, 0);
    return { lines: lines, answer: count, locations: A_locations };
  }

  // 建立所有頁面內容
  const pages = [];
  for (let p = 0; p < 20; p++) {
    const result = generatePageText('A');
    pages.push({ text: result.lines, answer: result.answer, locations: result.locations });
  }

  const timeline = []; // 儲存實驗流程

  // 首頁簡介
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Letter Search Task</h2><p>Please read the text below and find the letter "A". Total: 20 pages. Click the letters you found. Click all letters "A" you find. You have 2 minutes per page. Click "Continue" to go to the next page.</p>',
    choices: ['Start']
  });

  // 每一頁文章與互動
  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        clickedASet.clear(); // 每頁初始化點擊紀錄
        let html = '<div class="monofont">';
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`; // 每個字母一個唯一 ID
            html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}')">${char}</span>`;
          }
          html += '</div>'; // 結束每行
        });
        html += `</div><br><strong>Page ${index + 1}</strong>`;
        return html;
      },
      choices: ['Continue'], // 使用者需按下 Continue
      trial_duration: 120000, // 每頁最長 2 分鐘
      on_finish: function (data) {
        let correctCount = clickedASet.size; // 使用者點擊 A 的數量
        data.user_answer = correctCount; // 實際點擊數
        data.correct_answer = page.answer; // 正確 A 數量
        data.correct = (correctCount === page.answer);
        data.correct_diff = Math.min(correctCount, page.answer); // 答對數（不超過正解數）
        data.page_index = index + 1;
        data.page_time_sec = Math.round(data.rt / 1000); // 該頁花費時間（秒）
        data.page_accuracy = ((data.correct_diff / data.correct_answer) * 100).toFixed(1); // 每頁正確率
      }
    });
  });

  // 結果頁
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let resultHTML = '<h2>Results</h2><ol>';
      let totalCorrect = 0;
      let totalAnswer = 0;
      let totalTime = 0;

      // 每頁統計
      trials.forEach(t => {
        if (t.page_index) {
          const matched = Math.min(t.user_answer, t.correct_answer);
          totalCorrect += matched;
          totalAnswer += t.correct_answer;
          totalTime += t.page_time_sec || 0;
          const pageAccuracy = ((matched / t.correct_answer) * 100).toFixed(1);
          resultHTML += `<li>Page ${t.page_index}: You selected <strong>${t.user_answer}</strong> / Actual = <strong>${t.correct_answer}</strong> → Accuracy:  <strong>${pageAccuracy}%<br><strong> Time spent: ${t.page_time_sec} sec</li>`;
        }
      });

      const overallAccuracy = ((totalCorrect / totalAnswer) * 100).toFixed(1); // 總正確率

      // 顯示總結果
      resultHTML += `</ol><p><strong>Total A's Correct: ${totalCorrect}/${totalAnswer}</strong></p>`;
      resultHTML += `<p><strong>Total Time Spent: ${totalTime} seconds</strong></p>`;
      resultHTML += `<p><strong>Overall Accuracy: ${overallAccuracy}%</strong></p>`;
      return resultHTML;
    },
    choices: ['Finish']
  });

  // 點擊函式
  function toggleLetter(id, char) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct')) {
      el.classList.remove('letter-selected-correct'); // 取消標記
      clickedASet.delete(id); // 移除記錄
    } else {
      if (char === 'A') {
        el.classList.add('letter-selected-correct'); // 標記 A 為正確
        clickedASet.add(id); // 記錄這個 A 被點了
      }
    }
  }

  jsPsych.run(timeline); // 執行實驗流程
</script>
</html>
