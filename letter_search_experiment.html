<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <script src="plugin-survey-text.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: times new roman, sans-serif;
      padding: 80px;
    }
    .jspsych-content {
      max-width: 800px;
      margin: auto;
    }
  </style>
</head>
<body></body>
<script>
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData(); // 可改成 console.log(jsPsych.data.get()) 做自動紀錄
    }
  });

 function generateFakeLine(targetLetter, targetCount, lineLength = 40) {
  const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
  let line = '';
  while (line.length < lineLength - 5) { // 預留一點長度避免太滿
    let wordLength = Math.floor(Math.random() * 4) + 2; // 單字 2~5 字母
    let word = '';
    for (let i = 0; i < wordLength; i++) {
      word += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    // 加上空格再接下一個
    if (line.length + word.length + 1 <= lineLength) {
      line += word + ' ';
    } else {
      break;
    }
  }

  // 移除頭尾空格 + 補齊精確長度
  line = line.trim();
  // 若不足 40，補字母
  while (line.length < lineLength) {
    line += alphabet[Math.floor(Math.random() * alphabet.length)];
  }

  let flat = line.split('');
  let positions = [];
  while (positions.length < targetCount) {
    let idx = Math.floor(Math.random() * flat.length);
    if (flat[idx] !== targetLetter && flat[idx] !== ' ') {
      flat[idx] = targetLetter;
      positions.push(idx);
    }
  }
  return flat.join('');
}

  let pages = [];
  let answers = [];
  for (let p = 0; p < 20; p++) {
    let pageText = [];
    let totalTargets = 8;
    let inserted = 0;
    for (let i = 0; i < 25; i++) {
      let lineTargets = Math.min(2, totalTargets - inserted);
      let line = generateFakeLine('A', lineTargets);
      pageText.push(line);
      inserted += lineTargets;
    }
    pages.push(pageText.join('<br>'));
    answers.push(8);
  }

  let timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>請閱讀以下文章段落並找出其中的 "A" 字母</h2><p>共 20 頁，請輸入你找到的數量</p>',
    choices: ['開始']
  });

  pages.forEach((text, index) => {
    timeline.push({
      type: jsPsychSurveyText,
      preamble: `<div style="font-family:monospace; line-height:1.5;">${text}</div>`,
      questions: [
        {
          prompt: `第 ${index + 1} 頁：你看到幾個 A？`,
          name: `count_${index + 1}`,
          required: true
        }
      ]
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      let data = jsPsych.data.get().values();
      let correct = 0;
      for (let i = 0; i < 20; i++) {
        let input = data[i + 1].response[`count_${i + 1}`];
        if (parseInt(input) === answers[i]) {
          correct++;
        }
      }
      return `<h2>實驗結束</h2><p>你答對了 ${correct} / 20 頁</p>`;
    },
    choices: ['顯示詳細資料']
  });

  jsPsych.run(timeline);
</script>
</html>
