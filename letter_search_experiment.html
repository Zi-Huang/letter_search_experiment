<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /> <!-- 設定字元編碼為 UTF-8 -->
  <title>Letter Search Experiment</title> <!-- 頁面標題 -->
  <script src="jspsych.js"></script> <!-- 載入 jsPsych 主程式 -->
  <script src="plugin-html-button-response.js"></script> <!-- 載入按鈕互動插件 -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- 載入 jsPsych 樣式 -->
  <style>
    body {
      font-family: "Times New Roman", Times, serif; /* 設定主要字型 */
      padding: 40px; /* 頁面留白 */
    }
    .jspsych-content {
      max-width: 1400px; /* 最大寬度 */
      margin: auto;
      font-size: 20px; /* 預設文字大小 */
    }
    .letter-button {
      font-family: monospace; /* 使用等寬字型 */
      display: inline-block; /* 顯示為可排版方塊 */
      width: 20px; /* 固定寬度以防跑位 */
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.2;
      border-radius: 2px; /* 稍微圓角 */
      cursor: pointer;
      user-select: none;
    }
    .letter-selected-correct {
      background-color: gold; /* A 被選取顏色 */
      color: black;
    }
    .letter-selected-wrong {
      background-color: lightgray; /* 非 A 被選取顏色 */
      color: black;
    }
    .letter-line {
      margin-bottom: 6px;
      white-space: pre; /* 保留空格與換行 */
    }
    .monofont {
      font-family: monospace;
      font-size: 20px;
      white-space: pre;
    }
  </style>
</head>
<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData() // 實驗結束時顯示結果
  });

  // 產生一整頁的文字，含 8~15 個 A
  function generatePageText(targetLetter = 'A') {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ'; // 可用字母
    const lines = Array(25).fill(''); // 初始化 25 行
    const lineLength = 45; // 每行長度
    let totalTargets = Math.floor(Math.random() * 8) + 8; // 總 A 數量 8~15
    let availableLines = [...Array(25).keys()]; // 行索引陣列
    const A_locations = {}; // 紀錄每行 A 的位置

    // 分配 A 到隨機行與位置
    while (totalTargets > 0) {
      const lineIdx = availableLines[Math.floor(Math.random() * availableLines.length)];
      if (!A_locations[lineIdx]) A_locations[lineIdx] = [];
      if (A_locations[lineIdx].length < 2) {
        let pos;
        do {
          pos = Math.floor(Math.random() * lineLength);
        } while (A_locations[lineIdx].includes(pos));
        A_locations[lineIdx].push(pos);
        totalTargets--;
      }
    }

    // 為每行產生字串
    for (let i = 0; i < 25; i++) {
      const charArray = [];
      for (let j = 0; j < lineLength; j++) {
        if (A_locations[i] && A_locations[i].includes(j)) {
          charArray.push(targetLetter); // 插入 A
        } else {
          if (j > 0 && j < lineLength - 1 && Math.random() < 0.15) {
            charArray.push(' '); // 插入空格
          } else {
            charArray.push(alphabet[Math.floor(Math.random() * alphabet.length)]); // 插入其他字母
          }
        }
      }
      if (charArray[0] === ' ') charArray[0] = alphabet[Math.floor(Math.random() * alphabet.length)];
      if (charArray[lineLength - 1] === ' ') charArray[lineLength - 1] = alphabet[Math.floor(Math.random() * alphabet.length)];
      lines[i] = charArray.join(''); // 合併成一行
    }

    const count = Object.values(A_locations).reduce((acc, arr) => acc + arr.length, 0); // 統計總 A 數
    return { lines: lines, answer: count }; // 回傳頁面資料
  }

  const pages = [];
  for (let p = 0; p < 20; p++) {
    const result = generatePageText('A'); // 生成一頁文字
    pages.push({ text: result.lines, answer: result.answer });
  }

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Letter Search Task</h2><p>You will see 20 pages of fake text. Click all letters "A" you find. Then enter your count.</p>',
    choices: ['Start'] // 開始按鈕
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        let html = '<div class="monofont">';
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`; // 每個字一個 ID
            html += `<span id="${id}" class="letter-button" onclick="toggleLetter('${id}', '${char}')">${char}</span>`;
          }
          html += '</div>'; // 換行
        });
        html += `</div><br><strong>Page ${index + 1}</strong><br>`; // 顯示頁碼
        html += `<label for="count_input_${index}">How many A's did you find?</label>`; // 問題
        html += `<input type="number" id="count_input_${index}" /><br><br>`; // 輸入框
        html += `<button onclick="submitCount(${index}, ${page.answer})">Submit</button>`; // 提交按鈕
        return html; // 回傳 HTML
      },
      choices: [] // 不用預設按鈕
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let resultHTML = '<h2>Results</h2><ol>';
      let totalCorrect = 0;
      let totalAnswer = 0;

      trials.forEach(t => {
        if (t.user_answer !== undefined) {
          const correct = t.correct_answer;
          const matched = Math.min(t.user_answer, correct); // 答對的 A 數
          totalCorrect += matched;
          totalAnswer += correct;
          resultHTML += `<li>Page ${t.page_index}: You answered <strong>${t.user_answer}</strong> / Actual = <strong>${correct}</strong></li>`;
        }
      });

      resultHTML += `</ol><p><strong>Total A's Correct: ${totalCorrect}/${totalAnswer}</strong></p>`;
      return resultHTML; // 顯示總結
    },
    choices: ['Finish'] // 完成按鈕
  });

  function toggleLetter(id, char) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct') || el.classList.contains('letter-selected-wrong')) {
      el.classList.remove('letter-selected-correct');
      el.classList.remove('letter-selected-wrong');
    } else {
      if (char === 'A') {
        el.classList.add('letter-selected-correct');
      } else {
        el.classList.add('letter-selected-wrong');
      }
    }
  }

  function submitCount(index, correct_answer) {
    const val = parseInt(document.getElementById(`count_input_${index}`).value);
    if (isNaN(val)) {
      alert("Please enter a number.");
      return;
    }
    jsPsych.finishTrial({
      user_answer: val,
      correct_answer: correct_answer,
      page_index: index + 1
    });
  }

  jsPsych.run(timeline); // 啟動實驗
</script>
</html>
