<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-keyboard-response.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <script src="plugin-survey-text.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Times New Roman", serif;
      padding: 40px;
      background: #f4f4f4;
    }
    .jspsych-content {
      max-width: 1200px;
      margin: auto;
      font-size: 20px;
      text-align: center;
    }
    .letter-grid {
      font-family: monospace;
      font-size: 24px;
      line-height: 1.4;
      display: inline-block;
      text-align: left;
      user-select: none;
      white-space: pre;
    }
    .letter {
      display: inline-block;
      padding: 2px 4px;
      margin: 0;
      border-radius: 3px;
      cursor: pointer;
    }
    .highlight-a {
      background-color: gold;
      color: black;
    }
    .highlight-non-a {
      background-color: lightgray;
      color: black;
    }
    .input-section {
      margin-top: 20px;
    }
    input[type="number"] {
      font-size: 18px;
      padding: 4px 10px;
      width: 80px;
      text-align: center;
    }
    button {
      font-size: 18px;
      padding: 6px 16px;
    }
  </style>
</head>
<body>

<div id="experiment" class="jspsych-content"></div>

<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData()
  });

  function generateFakeLine(targetLetter, targetCount, lineLength = 45) {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
    let line = '';
    while (line.length < lineLength - 5) {
      let wordLength = Math.floor(Math.random() * 4) + 2;
      let word = '';
      for (let i = 0; i < wordLength; i++) {
        word += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      if (line.length + word.length + 1 <= lineLength) {
        line += word + ' ';
      } else {
        break;
      }
    }
    line = line.trim();
    while (line.length < lineLength) {
      line += alphabet[Math.floor(Math.random() * alphabet.length)];
    }

    let flat = line.split('');
    let positions = [];
    while (positions.length < targetCount) {
      let idx = Math.floor(Math.random() * flat.length);
      if (flat[idx] !== targetLetter && flat[idx] !== ' ') {
        flat[idx] = targetLetter;
        positions.push(idx);
      }
    }
    return flat.join('');
  }

  const pages = [];
  const answers = [];

  for (let p = 0; p < 20; p++) {
    let pageLines = [];
    let totalTargets = 0;
    for (let i = 0; i < 25; i++) {
      let lineTargets = Math.floor(Math.random() * 2) + 1; // 1–2 A's per line
      let line = generateFakeLine('A', lineTargets, 45);
      pageLines.push(line);
      totalTargets += lineTargets;
    }
    const finalTotal = Math.max(8, Math.min(15, totalTargets));
    answers.push(finalTotal);
    pages.push({ text: pageLines.join('\n'), lines: pageLines, answer: finalTotal });
  }

  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>Letter Search Task</h2>
    <p>Click on all the A's you can find in each paragraph. Click again to unselect. Then input how many A's you found.</p>
    <p>There are 20 pages. Each page has 8 to 15 A's. Click "Start" to begin.</p>`,
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: 'html-button-response',
      stimulus: function() {
        const container = document.createElement('div');
        container.innerHTML = `<div><strong>Page ${index + 1}</strong></div>`;
        const grid = document.createElement('div');
        grid.className = 'letter-grid';

        const letterStates = [];

        page.lines.forEach((line, lineIdx) => {
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const span = document.createElement('span');
            span.className = 'letter';
            span.textContent = char;

            let clicked = false;
            span.addEventListener('click', function () {
              clicked = !clicked;
              if (clicked) {
                span.classList.add(char === 'A' ? 'highlight-a' : 'highlight-non-a');
              } else {
                span.classList.remove('highlight-a', 'highlight-non-a');
              }
            });

            grid.appendChild(span);
          }
          grid.appendChild(document.createElement('br'));
        });

        const wrapper = document.createElement('div');
        wrapper.appendChild(container);
        wrapper.appendChild(grid);

        const inputDiv = document.createElement('div');
        inputDiv.className = 'input-section';
        inputDiv.innerHTML = `
          <label for="input_a">How many A's did you find?</label><br>
          <input type="number" id="input_a" min="0" required />
          <br><br>
          <button id="submit_page">Submit Page</button>
        `;
        wrapper.appendChild(inputDiv);

        setTimeout(() => {
          document.getElementById('experiment').innerHTML = '';
          document.getElementById('experiment').appendChild(wrapper);

          const startTime = Date.now();
          document.getElementById('submit_page').addEventListener('click', () => {
            const userInput = parseInt(document.getElementById('input_a').value);
            if (!isNaN(userInput)) {
              const timeSpent = Math.round((Date.now() - startTime) / 1000);
              jsPsych.finishTrial({
                user_answer: userInput,
                correct_answer: page.answer,
                correct: userInput === page.answer,
                correct_diff: Math.min(userInput, page.answer),
                page_index: index + 1,
                page_time_sec: timeSpent
              });
            } else {
              alert("Please enter a number.");
            }
          });
        }, 50);

        return ''; // jsPsych expects a return even if content is added manually
      },
      choices: []
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let html = `<h2>Results</h2><ol>`;
      let totalCorrect = 0;
      let totalAnswer = 0;
      let totalTime = 0;

      trials.forEach(trial => {
        totalCorrect += trial.correct_diff;
        totalAnswer += trial.correct_answer;
        totalTime += trial.page_time_sec;
        html += `<li>Page ${trial.page_index}: You answered <strong>${trial.user_answer}</strong>, Actual = <strong>${trial.correct_answer}</strong> → ${trial.correct ? '✅ Correct' : '❌'}<br>
        Time spent: ${trial.page_time_sec} sec</li>`;
      });

      html += `</ol><p><strong>Total A's Correct: ${totalCorrect} / ${totalAnswer}</strong></p>`;
      html += `<p><strong>Total Time Spent: ${totalTime} seconds</strong></p>`;
      return html;
    },
    choices: ['Finish']
  });

  jsPsych.run(timeline);
</script>
</body>
</html>
