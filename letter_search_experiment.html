<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Times New Roman", Times, serif;
      padding: 40px;
    }
    .jspsych-content {
      max-width: 1400px;
      margin: auto;
      font-size: 20px;
    }
    .letter-button {
      display: inline-block;
      padding: 2px 3px;
      margin: 0px;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
      font-size: 20px;
      line-height: 1.2;
    }
    .letter-selected-correct {
      background-color: gold;
      color: black;
    }
    .letter-selected-wrong {
      background-color: lightgray;
      color: black;
    }
    .letter-line {
      margin-bottom: 6px;
      white-space: pre;
    }
  </style>
</head>
<body></body>
<script>
  // 初始化 jsPsych 實驗
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData()
  });

  // 產生一行假英文段落，長度固定，A 數量由參數決定
  function generateFakeLine(targetLetter, targetCount, lineLength = 45) {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lineChars = [];

    // 建構一行，混合字母與空格，先填滿 45 個字元
    while (lineChars.length < lineLength) {
      if (
        lineChars.length > 0 &&
        lineChars.length < lineLength - 1 &&
        Math.random() < 0.15
      ) {
        // 插入空格，避免出現在開頭或結尾
        lineChars.push(' ');
      } else {
        // 插入隨機英文字母（不包含 A）
        lineChars.push(alphabet[Math.floor(Math.random() * alphabet.length)]);
      }
    }

    // 確保開頭與結尾不是空格
    if (lineChars[0] === ' ') {
      lineChars[0] = alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    if (lineChars[lineLength - 1] === ' ') {
      lineChars[lineLength - 1] = alphabet[Math.floor(Math.random() * alphabet.length)];
    }

    // 插入指定數量的 A，位置需為非空格
    let inserted = 0;
    while (inserted < targetCount) {
      let idx = Math.floor(Math.random() * lineLength);
      if (lineChars[idx] !== ' ' && lineChars[idx] !== targetLetter) {
        lineChars[idx] = targetLetter;
        inserted++;
      }
    }

    return lineChars.join('');
  }

  // 預先建立所有頁面資料
  const pages = [];   // 每頁段落文字
  const answers = []; // 每頁正確 A 數

  for (let p = 0; p < 20; p++) {
    let lines = [];
    let totalA = 0;

    // 每頁 25 行
    for (let i = 0; i < 25; i++) {
      // 每行隨機出現 0～2 個 A
      let lineA = Math.floor(Math.random() * 3); // 0, 1, 2
      let line = generateFakeLine('A', lineA, 45);
      lines.push(line);
      totalA += lineA;
    }

    // 強制每頁總 A 數限制在 8～15 之間
    if (totalA < 8 || totalA > 15) {
      p--; // 重生這一頁
      continue;
    }

    pages.push({ text: lines, answer: totalA });
    answers.push(totalA);
  }

  // 實驗流程（timeline）
  const timeline = [];

  // 任務開場介紹頁
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Letter Search Task</h2><p>You will see 20 pages of fake text. Click all letters "A" you find. Then enter your count.</p>',
    choices: ['Start']
  });

  // 為每一頁建立任務
  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        let html = '<div class="monofont">';
        
        // 顯示每一行文字，每個字母都可點擊
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" onclick="toggleLetter('${id}', '${char}')">${char}</span>`;
          }
          html += '</div>';
        });

        // 顯示頁碼與輸入框
        html += `</div><br><strong>Page ${index + 1}</strong><br>`;
        html += `<label for="count_input_${index}">How many A's did you find?</label>`;
        html += `<input type="number" id="count_input_${index}" /><br><br>`;
        html += `<button onclick="submitCount(${index}, ${page.answer})">Submit</button>`;
        return html;
      },
      choices: [] // 不使用 jsPsych 的預設按鈕，我們自己在 stimulus 裡建立
    });
  });

  // 結果頁面
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let resultHTML = '<h2>Results</h2><ol>';
      let totalCorrect = 0;
      let totalAnswer = 0;

      trials.forEach(t => {
        if (t.user_answer !== undefined) {
          const correct = t.correct_answer;
          const matched = Math.min(t.user_answer, correct); // 部分答對也記錄
          totalCorrect += matched;
          totalAnswer += correct;
          resultHTML += `<li>Page ${t.page_index}: You answered <strong>${t.user_answer}</strong> / Actual = <strong>${correct}</strong></li>`;
        }
      });

      resultHTML += `</ol><p><strong>Total A's Correct: ${totalCorrect}/${totalAnswer}</strong></p>`;
      return resultHTML;
    },
    choices: ['Finish']
  });

  // 點擊字母時切換樣式（黃底或灰底）
  function toggleLetter(id, char) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct') || el.classList.contains('letter-selected-wrong')) {
      el.classList.remove('letter-selected-correct');
      el.classList.remove('letter-selected-wrong');
    } else {
      if (char === 'A') {
        el.classList.add('letter-selected-correct');
      } else {
        el.classList.add('letter-selected-wrong');
      }
    }
  }

  // 使用者點擊 Submit 時記錄資料並繼續實驗
  function submitCount(index, correct_answer) {
    const val = parseInt(document.getElementById(`count_input_${index}`).value);
    if (isNaN(val)) {
      alert("Please enter a number.");
      return;
    }
    jsPsych.finishTrial({
      user_answer: val,
      correct_answer: correct_answer,
      page_index: index + 1
    });
  }

  // 執行實驗
  jsPsych.run(timeline);
</script>
</html>
