<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Search Experiment</title>
  <script src="jspsych.js"></script>
  <script src="plugin-html-button-response.js"></script>
  <script src="plugin-survey-text.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
    }
    .jspsych-content {
      max-width: 800px;
      margin: auto;
    }
  </style>
</head>
<body></body>
<script>
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData(); // 可改成 console.log(jsPsych.data.get()) 做自動紀錄
    }
  });

 function generateFakeLine(targetLetter, targetCount, lineLength = 40) {
  const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ';
  let line = '';
  while (line.length < lineLength - 5) { // 預留一點長度避免太滿
    let wordLength = Math.floor(Math.random() * 4) + 2; // 單字 2~5 字母
    let word = '';
    for (let i = 0; i < wordLength; i++) {
      word += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    // 加上空格再接下一個
    if (line.length + word.length + 1 <= lineLength) {
      line += word + ' ';
    } else {
      break;
    }
  }

  // 移除頭尾空格 + 補齊精確長度
  line = line.trim();
  // 若不足 40，補字母
  while (line.length < lineLength) {
    line += alphabet[Math.floor(Math.random() * alphabet.length)];
  }

  let flat = line.split('');
  let positions = [];
  while (positions.length < targetCount) {
    let idx = Math.floor(Math.random() * flat.length);
    if (flat[idx] !== targetLetter && flat[idx] !== ' ') {
      flat[idx] = targetLetter;
      positions.push(idx);
    }
  }
  return flat.join('');
}

  let pages = [];
  let answers = [];
  for (let p = 0; p < 20; p++) {
    let pageText = [];
    let totalTargets = 8;
    let inserted = 0;
    for (let i = 0; i < 25; i++) {
      let lineTargets = Math.min(2, totalTargets - inserted);
      let line = generateFakeLine('A', lineTargets);
      pageText.push(line);
      inserted += lineTargets;
    }
    pages.push(pageText.join('<br>'));
    answers.push(8);
  }

  let timeline = [];

  timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: function () {
    let trials = jsPsych.data.get().filter({ trial_type: 'survey-text' }).values();
    let resultHTML = "<h2>答題結果</h2><ol>";
    let correctCount = 0;

    trials.forEach(trial => {
      let page = trial.page_index;
      let correctAns = trial.correct_answer;
      let userAns = trial.user_answer;
      let isCorrect = trial.correct;
      let status = isCorrect ? "✅ 正確" : "❌ 錯誤";
      if (isCorrect) correctCount++;

      resultHTML += `
        <li>
          第 ${page} 頁：實際有 <strong>${correctAns}</strong> 個 A，
          你填了 <strong>${userAns}</strong> → ${status}
        </li>
      `;
    });

    resultHTML += `</ol><p><strong>總共答對 ${correctCount} / ${trials.length} 頁</strong></p>`;
    return resultHTML;
  },
  choices: ['完成']
});

  jsPsych.run(timeline);
</script>
</html>
