<!DOCTYPE html> <!-- å®£å‘Š HTML5 æ–‡ä»¶é¡å‹ -->
<html lang="en"> <!-- è¨­å®šèªè¨€ç‚ºè‹±æ–‡ -->
<head>
  <meta charset="UTF-8" /> <!-- è¨­å®šå­—å…ƒç·¨ç¢¼ -->
  <title>Letter Search Experiment</title> <!-- ç¶²é æ¨™é¡Œ -->
  <script src="jspsych.js"></script> <!-- è¼‰å…¥ jsPsych æ ¸å¿ƒè…³æœ¬ -->
  <script src="plugin-html-button-response.js"></script> <!-- è¼‰å…¥ html-button-response æ’ä»¶ -->
  <link href="jspsych.css" rel="stylesheet" /> <!-- è¼‰å…¥ jsPsych æ¨£å¼è¡¨ -->
  <style>
  
    html, body {
      margin: 0;
      padding: 0px;
      overflow-x: hidden; /* âœ… é˜²æ­¢ç•«é¢æ©«å‘æ²å‹• */
      box-sizing: border-box; /* ä¿è­‰ padding ä¸æœƒè¶…å‡ºå¯¬åº¦é™åˆ¶ */
    }
    body {
      font-family: "Times New Roman", Times, serif; /* è¨­å®šå­—é«”ç‚º Times New Roman */
      display: flex; /* ä½¿ç”¨ flex æ’ç‰ˆ */
      flex-direction: column; /* å‚ç›´æ’åˆ—å­å…ƒç´  */
      align-items: center; /* å­å…ƒç´ æ°´å¹³ç½®ä¸­ */
      padding: 2vh 0; /* ä¸Šä¸‹ç•™ç™½ 2% é«˜åº¦ */
      height: 100vh; /* é™åˆ¶è¦–çª—é«˜åº¦é˜²æ­¢éé«˜å…§å®¹è·‘å‡ºä¾† */
    }
    .jspsych-content {
      max-width: 100vw; /* æœ€å¤§å¯¬åº¦ç‚ºæ•´å€‹è¦–çª—å¯¬åº¦ */
      width: 90%; /* å¯¬åº¦ç‚ºè¢å¹• 90% */
      margin: auto; /* ç½®ä¸­ */
      font-size: 20px; /* æ–‡å­—å¤§å° */
    }
    .letter-button {
      font-family: monospace; /* ç­‰å¯¬å­—é«”ç¢ºä¿å°é½Š */
      display: inline-block;
      width: calc(100vw / 47); /* âš  æ ¹æ“šè¢å¹•å¯¬åº¦èª¿æ•´ï¼Œç´„åˆ†ç‚º 47 ä»½ï¼Œ45 å­—å…ƒåŠ é‚Šç•Œé ç•™ */
      text-align: center;
      padding: 0px;
      margin: 0px;
      line-height: 1.2;
      border-radius: 2px; /* å°åœ“è§’ */
      cursor: pointer;
      user-select: none; /* ç¦æ­¢æ–‡å­—é¸å– */
    }
    .letter-selected-correct {
      background-color: gold; /* é»é¸ A é¡¯ç¤ºé»ƒè‰²èƒŒæ™¯ */
      color: black;
    }
    .letter-line {
      margin-bottom: 4px; /* æ¯è¡Œåº•éƒ¨é–“è· */
      white-space: pre; /* ä¿ç•™ç©ºæ ¼èˆ‡æ’ç‰ˆ */
    }
    .monofont {
      font-family: monospace; /* ç­‰å¯¬å­—å‹ç¢ºä¿å­—å…ƒå°é½Š */
      font-size: 20px; /* å­—é«”å¤§å° */
      white-space: pre; /* ä¿ç•™ç©ºæ ¼ */
      display: inline-block; /* è®“æ•´å¡Šæ–‡å­—å¯ä»¥èª¿æ•´å¯¬åº¦ */
      width: fit-content; /* è‡ªå‹•èª¿æ•´å…§å®¹å¯¬åº¦ */
      max-width: 100vw; /* ä¸è¶…å‡ºè¢å¹•å¯¬åº¦ */
      overflow-x: hidden;                
    }
  </style>
</head>
<body>
  <div id="result-container"></div> <!-- é¡¯ç¤ºçµæœèˆ‡ä¸‹è¼‰æŒ‰éˆ•çš„å®¹å™¨ -->
</body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.displayData() // çµæŸå¾Œé¡¯ç¤ºè³‡æ–™
  });
  const clickedASet = new Set();

  // è¨­å®šæ•´ä»½å¯¦é©—ä¸­ç¸½å…±è¦å‡ºç¾çš„ A æ•¸ï¼ˆä¸æ”¹è®Šç¸½æ•¸ï¼‰
  const totalTargetAs = 240;
  const pages = [];
  const pageTargets = [];
  let remaining = totalTargetAs;

  // æ¯é éš¨æ©Ÿ 8~15 å€‹ Aï¼Œç¸½å’Œæ§åˆ¶ç‚º totalTargetAs
  for (let i = 0; i < 20; i++) {
    let min = Math.max(8, remaining - (15 * (19 - i))); // ä¿è­‰ä¹‹å¾Œèƒ½æ¹Šåˆ°ç¸½å’Œ
    let max = Math.min(15, remaining - (8 * (19 - i))); // ä¿è­‰ä¹‹å¾Œä¸æœƒè¶…éç¸½å’Œ
    const val = Math.floor(Math.random() * (max - min + 1)) + min;
    pageTargets.push(val);
    remaining -= val;
  }

  // ç”¢ç”Ÿå–®ä¸€é é¢æ–‡å­—å…§å®¹èˆ‡ A åˆ†å¸ƒ
  function generatePageText(targetLetter = 'A', totalTargets = 12) {
    const alphabet = 'BCDEFGHIJKLMNOPQRSTUVWXYZ'; // ä¸å« A çš„å­—æ¯
    const lines = Array(25).fill(''); // åˆå§‹åŒ– 25 è¡Œç©ºæ–‡å­—
    const lineLength = 45; // æ¯è¡Œ 45 å€‹å­—å…ƒ
    const A_locations = {}; // å„²å­˜ A çš„ä½ç½®ç´¢å¼•

    // éš¨æ©Ÿåœ¨ 25 è¡Œä¸­åˆ†é… Aï¼Œæ¯è¡Œæœ€å¤š 2 å€‹
    while (totalTargets > 0) {
      const lineIdx = Math.floor(Math.random() * 25);
      if (!A_locations[lineIdx]) A_locations[lineIdx] = [];
      if (A_locations[lineIdx].length < 2) {
        let pos;
        do {
          pos = Math.floor(Math.random() * lineLength);
        } while (A_locations[lineIdx].includes(pos));
        A_locations[lineIdx].push(pos);
        totalTargets--;
      }
    }

    // ç‚ºæ¯ä¸€è¡Œç”¢ç”Ÿå…§å®¹
    for (let i = 0; i < 25; i++) {
      const charArray = [];
      for (let j = 0; j < lineLength; j++) {
        if (A_locations[i] && A_locations[i].includes(j)) {
          charArray.push(targetLetter); // æ’å…¥ A
        } else {
          if (j > 0 && j < lineLength - 1 && Math.random() < 0.15) {
            charArray.push(' '); // æ’å…¥ç©ºæ ¼
          } else {
            charArray.push(alphabet[Math.floor(Math.random() * alphabet.length)]); // æ’å…¥éš¨æ©Ÿå­—æ¯
          }
        }
      }
      // é ­å°¾ä¸ç•™ç©ºæ ¼
      if (charArray[0] === ' ') charArray[0] = alphabet[Math.floor(Math.random() * alphabet.length)];
      if (charArray[lineLength - 1] === ' ') charArray[lineLength - 1] = alphabet[Math.floor(Math.random() * alphabet.length)];
      lines[i] = charArray.join('');
    }

    const count = Object.values(A_locations).reduce((acc, arr) => acc + arr.length, 0); // ç¸½ A æ•¸ç¢ºèª
    return { lines: lines, answer: count, locations: A_locations };
  }

  // æ ¹æ“šæ¯é æŒ‡å®šçš„ A æ•¸ç”¢ç”Ÿé é¢å…§å®¹
  for (let p = 0; p < 20; p++) {
    const result = generatePageText('A', pageTargets[p]);
    pages.push({ text: result.lines, answer: result.answer, locations: result.locations });
  }

  // ä»¥ä¸‹æµç¨‹ç¶­æŒä¸è®Š
  const timeline = [];

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>
        Letter Search Task
      </h2>
      <p>
        You will see 20 pages of fake text. Click all letters "A" you find.<br>
        You have 2 minutes/page. Click "Continue" to go to the next page.
      </p>`,
    choices: ['Start']
  });

  pages.forEach((page, index) => {
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        clickedASet.clear();
        let html = '<div class="monofont">';
        page.text.forEach((line, i) => {
          html += '<div class="letter-line">';
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const id = `char_${index}_${i}_${j}`;
            html += `<span id="${id}" class="letter-button" data-char="${char}" onclick="toggleLetter('${id}', '${char}')">${char}</span>`;
          }
          html += '</div>';
        });
        html += `</div><br><strong>Page ${index + 1}</strong>`;
        return html;
      },
      choices: ['Continue'],
      trial_duration: 120000,
      on_finish: function (data) {
        let correctCount = clickedASet.size;
        data.user_answer = correctCount;
        data.correct_answer = page.answer;
        data.correct = (correctCount === page.answer);
        data.correct_diff = Math.min(correctCount, page.answer);
        data.page_index = index + 1;
        data.page_time_sec = Math.round(data.rt / 1000);
        data.page_accuracy = ((data.correct_diff / data.correct_answer) * 100).toFixed(1);
      }
    });
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function () {
      const trials = jsPsych.data.get().filter({ trial_type: 'html-button-response' }).values();
      let resultHTML = '<h2>Results</h2><ol>';
      let totalCorrect = 0;
      let totalAnswer = 0;
      let totalTime = 0;
      let summary = [];

      trials.forEach(t => {
        if (t.page_index) {
          const matched = Math.min(t.user_answer, t.correct_answer);
          totalCorrect += matched;
          totalAnswer += t.correct_answer;
          totalTime += t.page_time_sec || 0;
          const pageAccuracy = ((matched / t.correct_answer) * 100).toFixed(1);
          resultHTML += `<li>Page ${t.page_index}: You selected <strong>${t.user_answer}</strong> / Actual = <strong>${t.correct_answer}</strong> â†’ Accuracy: <strong>${pageAccuracy}%</strong><br>Time spent: ${t.page_time_sec} sec</li>`;
          summary.push({
            Page: t.page_index,
            Answer: t.correct_answer,
            Correct: matched,
            "Time (sec)": t.page_time_sec,
            "Accuracy (%)": pageAccuracy
          });
        }
      });

      const overallAccuracy = ((totalCorrect / totalAnswer) * 100).toFixed(1);
      resultHTML += `</ol><p><strong>Total A's Correct: ${totalCorrect}/${totalAnswer}</strong></p>`;
      resultHTML += `<p><strong>Total Time Spent: ${totalTime} seconds</strong></p>`;
      resultHTML += `<p><strong>Overall Accuracy: <strong>${overallAccuracy}%</strong></p>`;
      resultHTML += `<br><button onclick="downloadCSV()">ğŸ“¥ Download Summary CSV</button>`;

      window.summaryData = summary;
      return resultHTML;
    },
    choices: ['Finish']
  });

  function toggleLetter(id, char) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.classList.contains('letter-selected-correct')) {
      el.classList.remove('letter-selected-correct');
      clickedASet.delete(id);
    } else {
      if (char === 'A') {
        el.classList.add('letter-selected-correct');
        clickedASet.add(id);
      }
    }
  }

  function downloadCSV() {
    const rows = window.summaryData;
    if (!rows || rows.length === 0) return;
    const header = Object.keys(rows[0]);
    const csv = [header.join(",")].concat(
      rows.map(r => header.map(h => r[h]).join(","))
    ).join("\n");

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `letter_search_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  jsPsych.run(timeline);
</script>
</html>
